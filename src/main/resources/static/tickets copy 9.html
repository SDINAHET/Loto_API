<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Tickets - Loto Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark p-3">
    <a class="navbar-brand" href="index_connexion.html">
        <i class="fas fa-home"></i> Accueil
    </a>
    <button class="btn btn-danger" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Se déconnecter
    </button>
</nav>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center">
        <h2 class="text-center">Mes Tickets Joués</h2>
        <button class="btn btn-success" onclick="addTicket()">
            <i class="fas fa-plus"></i> Ajouter un ticket
        </button>
    </div>

    <div class="card shadow-sm p-4 mt-3">
        <table class="table table-striped text-center">
            <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Numéros</th>
                    <th>Numéro Chance</th>
                    <th>Statut</th>
                    <th>Gains (€)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="ticketsTable">
                <tr><td colspan="6" class="text-center">Chargement des tickets...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ✅ MODAL Bootstrap pour afficher les numéros gagnants -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalLabel">Résultats du Tirage</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <p id="winningNumbers" class="fw-bold text-center"></p>
                <p id="chanceNumber" class="fw-bold text-center text-danger"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<script>
const API_URL = "http://localhost:8082/api/tickets";

let userRole = "USER";
let userId = null;

document.addEventListener("DOMContentLoaded", async function () {
    await checkUserAuth();
    await loadUserTickets();
});

async function checkUserAuth() {
    try {
        const response = await axios.get("http://localhost:8082/api/auth/me", { withCredentials: true });
        userId = response.data.id;
        userRole = response.data.role;
    } catch (error) {
        alert("Session expirée. Veuillez vous reconnecter.");
        window.location.href = "login.html";
    }
}

async function loadUserTickets() {
    try {
        let apiEndpoint = userRole === "ADMIN" ? `${API_URL}/all` : API_URL;
        const [ticketsResponse, gainsResponse] = await Promise.all([
            axios.get(apiEndpoint, { withCredentials: true }),
            axios.get("http://localhost:8082/api/gains", { withCredentials: true })
        ]);

        let tableBody = document.getElementById("ticketsTable");
        tableBody.innerHTML = "";

        if (!ticketsResponse.data.length) {
            tableBody.innerHTML = "<tr><td colspan='6' class='text-center'>Aucun ticket trouvé.</td></tr>";
            return;
        }

        const gainsMap = new Map(gainsResponse.data.map(g => [g.ticketId, g.gainAmount]));

        ticketsResponse.data.forEach(ticket => {
            let gainAmount = gainsMap.get(ticket.id) ?? "-";
            let status = gainAmount === "-" ? "En attente" : gainAmount > 0 ? "Gagné" : "Perdu";

            let row = `<tr>
                <td>${ticket.drawDate}</td>
                <td>${ticket.numbers.split("-").map(n => `<span class='badge bg-primary'>${n}</span>`).join(" ")}</td>
                <td><span class='badge bg-danger'>${ticket.chanceNumber}</span></td>
                <td><span class='badge ${status === "Gagné" ? "bg-success" : status === "Perdu" ? "bg-danger" : "bg-secondary"}'>${status}</span></td>
                <td>${gainAmount !== "-" ? `${gainAmount.toFixed(2)} €` : "-"}</td>
                <td>
                    <a class="btn btn-warning btn-sm" href="put_ticket.html?id=${ticket.id}">
                        <i class="fas fa-pen"></i>
                    </a>
                    <button class="btn btn-danger btn-sm" onclick="deleteTicket('${ticket.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-info btn-sm" onclick="showWinningNumbers('${ticket.drawDate}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>`;
            tableBody.innerHTML += row;
        });

    } catch (error) {
        document.getElementById("ticketsTable").innerHTML = "<tr><td colspan='6' class='text-danger text-center'>Erreur de chargement.</td></tr>";
    }
}

async function showWinningNumbers(drawDate) {
    try {
        const response = await axios.get(`http://localhost:8082/api/results/${drawDate}`, { withCredentials: true });
        let lotoResult = response.data;
        document.getElementById("winningNumbers").innerHTML = `<strong>Numéros Gagnants :</strong> ${lotoResult.numbers}`;
        document.getElementById("chanceNumber").innerHTML = `<strong>Numéro Chance :</strong> ${lotoResult.numeroChance}`;
        new bootstrap.Modal(document.getElementById("resultModal")).show();
    } catch (error) {
        alert("Aucun résultat disponible pour cette date.");
    }
}
</script>
</body>
</html>
