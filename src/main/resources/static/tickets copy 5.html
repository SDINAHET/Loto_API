<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Tickets - Loto Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* ‚úÖ Style des cercles des num√©ros */
        .number-circle {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            font-weight: bold;
            margin: 5px;
            color: white;
            background-color: blue;
        }
        .chance-circle {
            background-color: red;
        }
    </style>
</head>
<body class="bg-light">

<!-- ‚úÖ Navbar -->
<nav class="navbar navbar-dark bg-dark p-3">
    <a class="navbar-brand" href="index_connexion.html">
        <i class="fas fa-home"></i> Accueil
    </a>
    <button class="btn btn-danger" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Se d√©connecter
    </button>
</nav>

<!-- ‚úÖ Contenu principal -->
<div class="container mt-5">
    <h2 class="text-center">Mes Tickets Jou√©s</h2>

    <!-- ‚úÖ Bouton flottant pour ajouter un ticket -->
    <a href="post_ticket.html" class="btn btn-primary rounded-circle position-fixed bottom-3 end-3 p-3"
    style="right: 20px; bottom: 20px;">
        <i class="fas fa-plus fa-2x"></i>
    </a>

    <!-- ‚úÖ Tableau des tickets -->
    <div class="card shadow-sm p-4 mt-3">
        <table class="table table-striped text-center">
            <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Num√©ros</th>
                    <th>Num√©ro Chance</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="ticketsTable">
                <tr><td colspan="5" class="text-center">Chargement des tickets...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ‚úÖ Scripts -->
<script>
document.addEventListener("DOMContentLoaded", async function () {
    await checkUserAuth();
    await loadUserTickets();
});

// ‚úÖ V√©rifier si l'utilisateur est connect√©
async function checkUserAuth() {
    try {
        const response = await axios.get("http://localhost:8082/api/auth/me", { withCredentials: true });
        if (!(response.status === 200 && response.data.email)) {
            alert("Vous devez √™tre connect√© pour acc√©der √† cette page.");
            window.location.href = "login.html";
        }
    } catch (error) {
        alert("Session expir√©e. Veuillez vous reconnecter.");
        window.location.href = "login.html";
    }
}

// ‚úÖ Formater la date en fran√ßais
function formatDateFr(dateStr) {
    if (!dateStr) return "N/A";
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return "N/A";
    return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
}

// ‚úÖ Convertir les num√©ros string en cercles bleus
function formatNumbers(numbersStr) {
    if (!numbersStr || typeof numbersStr !== "string") return "<span class='text-muted'>Aucun num√©ro</span>";

    let numbers = numbersStr.split("-")
        .map(num => parseInt(num.trim()))
        .filter(num => !isNaN(num));

    if (numbers.length === 0) return "<span class='text-muted'>Aucun num√©ro</span>";

    return numbers.map(num => `<span class="number-circle">${num}</span>`).join(" ");
}

// ‚úÖ Charger les tickets de l'utilisateur
async function loadUserTickets() {
    try {
        const response = await axios.get("http://localhost:8082/api/tickets", { withCredentials: true });

        let tableBody = document.getElementById("ticketsTable");
        tableBody.innerHTML = "";

        if (!response.data || response.data.length === 0) {
            tableBody.innerHTML = "<tr><td colspan='5' class='text-center'>Aucun ticket trouv√©.</td></tr>";
            return;
        }

        // ‚úÖ Tri des tickets par date (du plus r√©cent au plus ancien)
        response.data.sort((a, b) => new Date(b.drawDate) - new Date(a.drawDate));

        response.data.forEach(ticket => {
            let formattedDate = ticket.drawDate ? formatDateFr(ticket.drawDate) : "N/A";
            let numbersHtml = formatNumbers(ticket.numbers);
            let chanceHtml = ticket.chanceNumber
                ? `<span class="number-circle chance-circle">${ticket.chanceNumber}</span>`
                : "<span class='text-muted'>N/A</span>";

            // ‚úÖ D√©finition du statut
            let statusHtml = "<span class='badge bg-secondary'>‚è≥ En attente</span>";
            if (ticket.status === "WIN") {
                statusHtml = `<span class='badge bg-success'>üèÜ Gagn√© : ${ticket.gain || 0} ‚Ç¨</span>`;
            } else if (ticket.status === "LOSE") {
                statusHtml = "<span class='badge bg-danger'>‚ùå Perdu</span>";
            }

            let row = `<tr>
                <td>${formattedDate}</td>
                <td>${numbersHtml}</td>
                <td>${chanceHtml}</td>
                <td>${statusHtml}</td>
                <td>
                    <a class="btn btn-warning btn-sm" href="put_ticket.html?id=${ticket.id}">
                        <i class="fas fa-pen"></i>
                    </a>
                    <button class="btn btn-danger btn-sm" onclick="deleteTicket('${ticket.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
            tableBody.innerHTML += row;
        });

    } catch (error) {
        console.error("‚ùå Erreur lors du chargement des tickets:", error);
        document.getElementById("ticketsTable").innerHTML = "<tr><td colspan='5' class='text-center text-danger'>‚ùå Erreur de chargement.</td></tr>";
    }
}

// ‚úÖ Supprimer un ticket
async function deleteTicket(id) {
    if (confirm("Voulez-vous vraiment supprimer ce ticket ?")) {
        await axios.delete(`http://localhost:8082/api/tickets/${id}`, { withCredentials: true });
        await loadUserTickets(); // üî• Ajout du `await` pour √©viter l'affichage d'un ticket supprim√©
    }
}

// ‚úÖ D√©connexion
async function logout() {
    await axios.post("http://localhost:8082/api/auth/logout", {}, { withCredentials: true });
    window.location.href = "index.html";
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
