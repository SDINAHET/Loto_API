<!-- <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Tickets - Loto Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark p-3">
    <a class="navbar-brand" href="index_connexion.html">
        <i class="fas fa-home"></i> Accueil
    </a>
    <button class="btn btn-danger" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Se d√©connecter
    </button>
</nav>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center">
        <h2 class="text-center">Mes Tickets Jou√©s</h2>
        <button class="btn btn-success" onclick="addTicket()">
            <i class="fas fa-plus"></i> Ajouter un ticket
        </button>
    </div>

    <div class="card shadow-sm p-4 mt-3">
        <table class="table table-striped text-center">
            <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Num√©ros</th>
                    <th>Num√©ro Chance</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="ticketsTable">
                <tr><td colspan="5" class="text-center">Chargement des tickets...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
const API_URL = "http://localhost:8082/api/tickets";
let userRole = "USER"; // Par d√©faut
let userId = null; // Stocker l'ID utilisateur

document.addEventListener("DOMContentLoaded", async function () {
    await checkUserAuth();
    await loadUserTickets();
});

// ‚úÖ V√©rifie si l'utilisateur est authentifi√© et stocke ses infos
async function checkUserAuth() {
    try {
        console.log("üîπ V√©rification de l'utilisateur connect√©...");
        const response = await axios.get("http://localhost:8082/api/auth/me", { withCredentials: true });

        if (response.status !== 200 || !response.data.email) {
            console.warn("‚ùå Utilisateur non authentifi√©.");
            alert("Vous devez √™tre connect√© pour acc√©der √† cette page.");
            window.location.href = "login.html";
            return;
        }

        userId = response.data.id;
        userRole = response.data.role;
        console.log("‚úÖ Utilisateur connect√© :", response.data);

    } catch (error) {
        console.error("‚ùå Erreur lors de la v√©rification de l'utilisateur :", error.response || error);
        alert("Session expir√©e. Veuillez vous reconnecter.");
        window.location.href = "login.html";
    }
}

// ‚úÖ Charge les tickets du joueur ou tous les tickets si ADMIN
async function loadUserTickets() {
    try {
        console.log("üîπ Chargement des tickets...");
        let apiEndpoint = API_URL;

        // Si ADMIN, r√©cup√©rer tous les tickets
        if (userRole === "ADMIN") {
            apiEndpoint += "/all";
        }

        // Envoie automatiquement le cookie JWT avec `withCredentials: true`
        const response = await axios.get(apiEndpoint, { withCredentials: true });

        console.log("‚úÖ R√©ponse API re√ßue :", response.data);

        let tableBody = document.getElementById("ticketsTable");
        tableBody.innerHTML = "";

        if (!response.data || response.data.length === 0) {
            console.warn("‚ÑπÔ∏è Aucun ticket trouv√©.");
            tableBody.innerHTML = "<tr><td colspan='5' class='text-center'>Aucun ticket trouv√©.</td></tr>";
            return;
        }

        response.data.sort((a, b) => new Date(b.drawDate) - new Date(a.drawDate));

        response.data.forEach(ticket => {
            let row = `<tr>
                <td>${formatDate(ticket.drawDate)}</td>
                <td>${formatNumbers(ticket.numbers)}</td>
                <td>${formatChance(ticket.chanceNumber)}</td>
                <td>${formatStatus(ticket.status, ticket.gain)}</td>
                <td>
                    <a class="btn btn-warning btn-sm" href="put_ticket.html?id=${ticket.id}">
                        <i class="fas fa-pen"></i>
                    </a>
                    <button class="btn btn-danger btn-sm" onclick="deleteTicket('${ticket.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
            tableBody.innerHTML += row;
        });

    } catch (error) {
        console.error("‚ùå Erreur lors du chargement des tickets :", error.response || error);
        document.getElementById("ticketsTable").innerHTML = "<tr><td colspan='5' class='text-center text-danger'>Erreur de chargement.</td></tr>";
    }
}

// ‚úÖ Supprime un ticket avec confirmation
async function deleteTicket(id) {
    if (confirm("Voulez-vous vraiment supprimer ce ticket ?")) {
        try {
            console.log(`üóëÔ∏è Suppression du ticket ID : ${id}`);
            await axios.delete(`${API_URL}/${id}`, { withCredentials: true });
            await loadUserTickets();
        } catch (error) {
            console.error("‚ùå Erreur lors de la suppression du ticket :", error.response || error);
        }
    }
}

// ‚úÖ Ajoute un ticket (redirige vers une page d'ajout)
function addTicket() {
    window.location.href = "post_ticket.html";
}

// ‚úÖ Formate la date au format fran√ßais
function formatDate(dateStr) {
    if (!dateStr) return "N/A";
    const date = new Date(dateStr);
    return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
}

// ‚úÖ Affiche les num√©ros sous forme de badges
function formatNumbers(numbersStr) {
    return numbersStr ? numbersStr.split("-").map(num => `<span class="badge bg-primary">${num}</span>`).join(" ") : "N/A";
}

// ‚úÖ Affiche le num√©ro chance
function formatChance(num) {
    return num ? `<span class="badge bg-danger">${num}</span>` : "N/A";
}

// ‚úÖ Formate le statut du ticket
function formatStatus(status, gain) {
    if (status === "WIN") {
        return `<span class='badge bg-success'>Gagn√©: ${gain || 0} ‚Ç¨</span>`;
    } else if (status === "LOSE") {
        return "<span class='badge bg-danger'>Perdu</span>";
    }
    return "<span class='badge bg-secondary'>En attente</span>";
}

// ‚úÖ G√®re la d√©connexion en supprimant le cookie JWT
async function logout() {
    try {
        console.log("üîπ D√©connexion de l'utilisateur...");
        await axios.post("http://localhost:8082/api/auth/logout", {}, { withCredentials: true });
        window.location.href = "index.html";
    } catch (error) {
        console.error("‚ùå Erreur lors de la d√©connexion :", error.response || error);
    }
}
</script>

</body>
</html> -->


<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Tickets - Loto Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark p-3">
    <a class="navbar-brand" href="index_connexion.html">
        <i class="fas fa-home"></i> Accueil
    </a>
    <button class="btn btn-danger" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Se d√©connecter
    </button>
</nav>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center">
        <h2 class="text-center">Mes Tickets Jou√©s</h2>
        <button class="btn btn-success" onclick="addTicket()">
            <i class="fas fa-plus"></i> Ajouter un ticket
        </button>
    </div>

    <div class="card shadow-sm p-4 mt-3">
        <table class="table table-striped text-center">
            <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Num√©ros</th>
                    <th>Num√©ro Chance</th>
                    <th>Statut</th>
                    <th>Gains (‚Ç¨)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="ticketsTable">
                <tr><td colspan="6" class="text-center">Chargement des tickets...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
const API_URL = "http://localhost:8082/api/tickets";
let userRole = "USER";
let userId = null;

document.addEventListener("DOMContentLoaded", async function () {
    await checkUserAuth();
    await loadUserTickets();
});

// ‚úÖ V√©rifie si l'utilisateur est authentifi√© et stocke ses infos
async function checkUserAuth() {
    try {
        console.log("üîπ V√©rification de l'utilisateur connect√©...");
        const response = await axios.get("http://localhost:8082/api/auth/me", { withCredentials: true });

        if (response.status !== 200 || !response.data.email) {
            console.warn("‚ùå Utilisateur non authentifi√©.");
            alert("Vous devez √™tre connect√© pour acc√©der √† cette page.");
            window.location.href = "login.html";
            return;
        }

        userId = response.data.id;
        userRole = response.data.role;
        console.log("‚úÖ Utilisateur connect√© :", response.data);

    } catch (error) {
        console.error("‚ùå Erreur lors de la v√©rification de l'utilisateur :", error.response || error);
        alert("Session expir√©e. Veuillez vous reconnecter.");
        window.location.href = "login.html";
    }
}

// ‚úÖ Charge les tickets du joueur ou tous les tickets si ADMIN
async function loadUserTickets() {
    try {
        console.log("üîπ Chargement des tickets...");
        let apiEndpoint = API_URL;

        if (userRole === "ADMIN") {
            apiEndpoint += "/all";
        }

        const response = await axios.get(apiEndpoint, { withCredentials: true });

        console.log("‚úÖ R√©ponse API re√ßue :", response.data);

        let tableBody = document.getElementById("ticketsTable");
        tableBody.innerHTML = "";

        if (!response.data || response.data.length === 0) {
            console.warn("‚ÑπÔ∏è Aucun ticket trouv√©.");
            tableBody.innerHTML = "<tr><td colspan='6' class='text-center'>Aucun ticket trouv√©.</td></tr>";
            return;
        }

        response.data.sort((a, b) => new Date(b.drawDate) - new Date(a.drawDate));

        response.data.forEach(ticket => {
            let row = `<tr>
                <td>${formatDate(ticket.drawDate)}</td>
                <td>${formatNumbers(ticket.numbers)}</td>
                <td>${formatChance(ticket.chanceNumber)}</td>
                <td>${formatStatus(ticket.status)}</td>
                <td>${formatGain(ticket.gain)}</td>
                <td>
                    <a class="btn btn-warning btn-sm" href="put_ticket.html?id=${ticket.id}">
                        <i class="fas fa-pen"></i>
                    </a>
                    <button class="btn btn-danger btn-sm" onclick="deleteTicket('${ticket.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
            tableBody.innerHTML += row;
        });

    } catch (error) {
        console.error("‚ùå Erreur lors du chargement des tickets :", error.response || error);
        document.getElementById("ticketsTable").innerHTML = "<tr><td colspan='6' class='text-center text-danger'>Erreur de chargement.</td></tr>";
    }
}

// ‚úÖ Supprime un ticket avec confirmation
async function deleteTicket(id) {
    if (confirm("Voulez-vous vraiment supprimer ce ticket ?")) {
        try {
            console.log(`üóëÔ∏è Suppression du ticket ID : ${id}`);
            await axios.delete(`${API_URL}/${id}`, { withCredentials: true });
            await loadUserTickets();
        } catch (error) {
            console.error("‚ùå Erreur lors de la suppression du ticket :", error.response || error);
        }
    }
}

// ‚úÖ Ajoute un ticket (redirige vers une page d'ajout)
function addTicket() {
    window.location.href = "post_ticket.html";
}

// ‚úÖ Formate la date au format fran√ßais
function formatDate(dateStr) {
    if (!dateStr) return "N/A";
    const date = new Date(dateStr);
    return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
}

// ‚úÖ Affiche les num√©ros sous forme de badges
function formatNumbers(numbersStr) {
    return numbersStr ? numbersStr.split("-").map(num => `<span class="badge bg-primary">${num}</span>`).join(" ") : "N/A";
}

// ‚úÖ Affiche le num√©ro chance
function formatChance(num) {
    return num ? `<span class="badge bg-danger">${num}</span>` : "N/A";
}

// ‚úÖ Formate le statut du ticket
function formatStatus(status) {
    switch (status) {
        case "WIN":
            return "<span class='badge bg-success'>Gagn√©</span>";
        case "LOSE":
            return "<span class='badge bg-danger'>Perdu</span>";
        default:
            return "<span class='badge bg-secondary'>En attente</span>";
    }
}

// ‚úÖ Formate les gains
function formatGain(gain) {
    return gain !== undefined && gain !== null ? `<span class="fw-bold">${gain.toFixed(2)} ‚Ç¨</span>` : "-";
}

// ‚úÖ G√®re la d√©connexion en supprimant le cookie JWT
async function logout() {
    try {
        console.log("üîπ D√©connexion de l'utilisateur...");
        await axios.post("http://localhost:8082/api/auth/logout", {}, { withCredentials: true });
        window.location.href = "index.html";
    } catch (error) {
        console.error("‚ùå Erreur lors de la d√©connexion :", error.response || error);
    }
}
</script>

</body>
</html>
