<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Tickets - Loto Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">

<!-- ‚úÖ Navbar -->
<nav class="navbar navbar-dark bg-dark p-3">
    <a class="navbar-brand" href="index_connexion.html">
        <i class="fas fa-home"></i> Accueil
    </a>
    <button class="btn btn-danger" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Se d√©connecter
    </button>
</nav>

<!-- ‚úÖ Contenu principal -->
<div class="container mt-5">
    <h2 class="text-center">Mes Tickets Jou√©s</h2>

    <!-- ‚úÖ Tableau des tickets -->
    <div class="card shadow-sm p-4 mt-3">
        <table class="table table-striped text-center">
            <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Num√©ros</th>
                    <th>Num√©ro Chance</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="ticketsTable">
                <tr><td colspan="5" class="text-center">Chargement des tickets...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ‚úÖ Bouton flottant pour ajouter un ticket -->
<button class="btn btn-primary rounded-circle position-fixed bottom-3 end-3 p-3" style="right: 20px; bottom: 20px;"
        onclick="openTicketModal()">
    <i class="fas fa-plus fa-2x"></i>
</button>

<!-- ‚úÖ MODAL : Ajouter / Modifier un ticket -->
<div class="modal fade" id="ticketModal" tabindex="-1" aria-labelledby="ticketModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ticketModalLabel">Ajouter / Modifier un Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ticketForm">
                    <input type="hidden" id="ticketId">
                    <div class="mb-3">
                        <label for="ticketDate" class="form-label">Date :</label>
                        <input type="date" class="form-control" id="ticketDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="ticketNumbers" class="form-label">Num√©ros (s√©par√©s par des virgules) :</label>
                        <input type="text" class="form-control" id="ticketNumbers" required>
                    </div>
                    <div class="mb-3">
                        <label for="ticketChance" class="form-label">Num√©ro Chance :</label>
                        <input type="number" class="form-control" id="ticketChance" min="1" max="10" required>
                    </div>
                    <button type="submit" class="btn btn-success">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ Scripts -->
<script>
document.addEventListener("DOMContentLoaded", async function () {
    await checkUserAuth();
    await loadUserTickets();
});

// ‚úÖ V√©rifier si l'utilisateur est connect√©
async function checkUserAuth() {
    try {
        const response = await axios.get("http://localhost:8082/api/auth/me", { withCredentials: true });
        if (!(response.status === 200 && response.data.email)) {
            alert("Vous devez √™tre connect√© pour acc√©der √† cette page.");
            window.location.href = "login.html";
        }
    } catch (error) {
        alert("Session expir√©e. Veuillez vous reconnecter.");
        window.location.href = "login.html";
    }
}

function formatDateFr(dateStr) {
    if (!dateStr || dateStr === "null" || dateStr === "undefined") return "N/A";  // üî• Protection anti-erreur

    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return "N/A";  // üî• Si la date est invalide

    const options = { day: '2-digit', month: 'long', year: 'numeric' };
    return date.toLocaleDateString('fr-FR', options);
}



// ‚úÖ Charger les tickets de l'utilisateur
async function loadUserTickets() {
    try {
        const response = await axios.get("http://localhost:8082/api/tickets", { withCredentials: true });

        console.log("üì• R√©ponse API re√ßue :", response.data); // üîç Debugging

        let tableBody = document.getElementById("ticketsTable");
        tableBody.innerHTML = "";

        if (!response.data || response.data.length === 0) {
            tableBody.innerHTML = "<tr><td colspan='5' class='text-center'>Aucun ticket trouv√©.</td></tr>";
            return;
        }

        response.data.forEach(ticket => {
            console.log("üé´ Ticket re√ßu :", ticket); // üîç V√©rifier chaque ticket

            let statusHtml = "<span class='badge bg-secondary'>‚è≥ En attente</span>";
            if (ticket.status === "WIN") {
                statusHtml = `<span class='badge bg-success'>üèÜ Gagn√© : ${ticket.gain || 0} ‚Ç¨</span>`;
            } else if (ticket.status === "LOSE") {
                statusHtml = "<span class='badge bg-danger'>‚ùå Perdu</span>";
            }

            // ‚úÖ V√©rifier si ticket.numbers est bien un tableau
            let numbersDisplay = Array.isArray(ticket.numbers) && ticket.numbers.length > 0
                ? ticket.numbers.join(", ")
                : "Aucun num√©ro";

            // ‚úÖ V√©rifier si drawDate est une cha√Æne valide avant conversion
            let formattedDate = ticket.drawDate ? formatDateFr(ticket.drawDate) : "N/A";

            let row = `<tr>
                <td>${formattedDate}</td>
                <td>${numbersDisplay}</td>
                <td>${ticket.chanceNumber || "N/A"}</td>
                <td>${statusHtml}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="openTicketModal('${ticket.id}', '${ticket.drawDate}', '${ticket.numbers}', ${ticket.chanceNumber})">
                        <i class="fas fa-pen"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTicket('${ticket.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
            tableBody.innerHTML += row;
        });

    } catch (error) {
        console.error("‚ùå Erreur lors du chargement des tickets:", error);
        document.getElementById("ticketsTable").innerHTML = "<tr><td colspan='5' class='text-center text-danger'>‚ùå Erreur de chargement.</td></tr>";
    }
}




// ‚úÖ Ajouter ou modifier un ticket
document.getElementById("ticketForm").addEventListener("submit", async function (event) {
    event.preventDefault();

    const id = document.getElementById("ticketId").value;
    const ticketData = {
        drawDate: document.getElementById("ticketDate").value,
        numbers: document.getElementById("ticketNumbers").value.split(",").map(num => parseInt(num.trim())),
        chanceNumber: parseInt(document.getElementById("ticketChance").value)
    };

    try {
        if (id) {
            await axios.put(`http://localhost:8082/api/tickets/${id}`, ticketData, { withCredentials: true });
        } else {
            await axios.post("http://localhost:8082/api/tickets", ticketData, { withCredentials: true });
        }

        loadUserTickets();
        new bootstrap.Modal(document.getElementById("ticketModal")).hide();
    } catch (error) {
        alert("Erreur lors de l'enregistrement.");
    }
});

// ‚úÖ Supprimer un ticket
async function deleteTicket(id) {
    if (confirm("Voulez-vous vraiment supprimer ce ticket ?")) {
        await axios.delete(`http://localhost:8082/api/tickets/${id}`, { withCredentials: true });
        loadUserTickets();
    }
}

// ‚úÖ D√©connexion
async function logout() {
    await axios.post("http://localhost:8082/api/auth/logout", {}, { withCredentials: true });
    window.location.href = "index.html";
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
