<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifier mon profil - Loto Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">

<!-- ✅ Navbar -->
<nav class="navbar navbar-dark bg-dark p-3">
    <a class="navbar-brand" href="index_connexion.html">
        <i class="fas fa-home"></i> Accueil
    </a>
    <button class="btn btn-danger" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Se déconnecter
    </button>
</nav>

<!-- ✅ Contenu principal -->
<div class="container mt-5">
    <h2 class="text-center">Modifier mon profil</h2>

    <form id="profileForm" class="mt-4">
        <!-- <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="email" readonly>
        </div>
        <div class="mb-3">
            <label class="form-label">Prénom</label>
            <input type="text" class="form-control" id="firstName" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Nom</label>
            <input type="text" class="form-control" id="lastName" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Mot de passe (laisser vide si inchangé)</label>
            <input type="password" class="form-control" id="password">
        </div>
        <button type="submit" class="btn btn-primary">Enregistrer les modifications</button> -->
        <!-- ✅ Mot de passe actuel pour déverrouiller la modification -->
        <div class="mb-3">
            <label for="currentPassword" class="form-label">Mot de passe actuel :</label>
            <div class="input-group">
                <input type="password" class="form-control" id="currentPassword" required>
                <button class="btn btn-outline-secondary" type="button" id="unlockEdit">
                    <i class="fas fa-lock"></i>
                </button>
            </div>
        </div>

        <!-- ✅ Champ Email (non modifiable) -->
        <div class="mb-3">
            <label for="email" class="form-label">Email :</label>
            <input type="email" class="form-control" id="email" disabled>
        </div>

        <!-- ✅ Champ Prénom -->
        <div class="mb-3">
            <label for="firstName" class="form-label">Prénom :</label>
            <div class="input-group">
                <input type="text" class="form-control" id="firstName" disabled>
                <button class="btn btn-outline-secondary" type="button" id="ediFirsttName" disabled>
                    <i class="fas fa-pen"></i>
                </button>
            </div>
        </div>

        <!-- ✅ Champ Nom avec bouton d'édition -->
        <div class="mb-3">
            <label for="lastName" class="form-label">Nom :</label>
            <div class="input-group">
                <input type="text" class="form-control" id="lastName" disabled>
                <button class="btn btn-outline-secondary" type="button" id="editLastName" disabled>
                    <i class="fas fa-pen"></i>
                </button>
            </div>
        </div>

        <!-- ✅ Nouveau mot de passe -->
        <div class="mb-3">
            <label for="newPassword" class="form-label">Nouveau mot de passe (laisser vide si inchangé) :</label>
            <div class="input-group">
                <input type="password" class="form-control" id="newPassword" disabled>
                <button class="btn btn-outline-secondary" type="button" id="editNewPassword" disabled>
                    <i class="fas fa-pen"></i>
                </button>
            </div>
        </div>

        <!-- ✅ Confirmation du mot de passe -->
        <div class="mb-3">
            <label for="confirmPassword" class="form-label">Confirmer le nouveau mot de passe :</label>
            <div class="input-group">
                <input type="password" class="form-control" id="confirmPassword" disabled>
                <button class="btn btn-outline-secondary" type="button" id="editConfirmPassword" disabled>
                    <i class="fas fa-pen"></i>
                </div>
        </div>

        <!-- ✅ Bouton Enregistrer -->
        <button type="submit" class="btn btn-primary w-100" id="saveChanges" disabled>
            Enregistrer les modifications
        </button>

    </form>
</div>

<!-- ✅ JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", async function () {
    await loadUserProfile();
});

// ✅ Récupérer les infos de l'utilisateur
async function loadUserProfile() {
    try {
        const response = await axios.get("http://localhost:8082/api/auth/me", { withCredentials: true });

        // Remplir le formulaire avec les données
        document.getElementById("email").value = response.data.email;
        document.getElementById("firstName").value = response.data.first_name;
        document.getElementById("lastName").value = response.data.last_name;

        // Sauvegarder l'ID de l'utilisateur
        document.getElementById("profileForm").setAttribute("data-user-id", response.data.id);

    } catch (error) {
        alert("Erreur lors de la récupération du profil !");
        window.location.href = "login.html"; // Rediriger si l'utilisateur n'est pas connecté
    }
}

// ✅ Mettre à jour les informations de l'utilisateur
document.getElementById("profileForm").addEventListener("submit", async function (event) {
    event.preventDefault();

    let userId = this.getAttribute("data-user-id"); // Récupérer l'ID
    let firstName = document.getElementById("firstName").value;
    let lastName = document.getElementById("lastName").value;
    let password = document.getElementById("password").value;

    let updatedData = {
        firstName: firstName,
        lastName: lastName
    };

    if (password.trim() !== "") {
        updatedData.password = password;
    }

    try {
        await axios.put(`http://localhost:8082/api/users/${userId}`, updatedData, { withCredentials: true });

        alert("Profil mis à jour avec succès !");
        loadUserProfile(); // Recharger les infos mises à jour

    } catch (error) {
        alert("Erreur lors de la mise à jour !");
    }
});

// ✅ Déconnexion
async function logout() {
    try {
        await axios.post("http://localhost:8082/api/auth/logout", {}, { withCredentials: true });

        alert("Déconnexion réussie !");
        window.location.href = "index.html";

    } catch (error) {
        alert("Erreur lors de la déconnexion.");
    }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
