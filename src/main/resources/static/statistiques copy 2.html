<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiques - Loto Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<!-- ✅ Navbar -->
<nav class="navbar navbar-dark bg-dark p-3">
    <a class="navbar-brand" href="index_connexion.html">
        <i class="fas fa-home"></i> Accueil
    </a>
    <button class="btn btn-danger" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Se déconnecter
    </button>
</nav>

<!-- ✅ Contenu principal -->
<div class="container mt-5">
    <h2 class="text-center">Statistiques de mes Tirages</h2>
    <div class="row mt-4">
        <div class="col-md-6">
            <h5>📅 Historique des Tirages</h5>
            <ul id="historiqueList" class="list-group"></ul>
        </div>
        <div class="col-md-6">
            <canvas id="statsChart"></canvas>
        </div>
    </div>

    <div class="text-center mt-4">
        <h4>Total Dépensé : <span id="totalDepense" class="text-danger">0</span> €</h4>
        <h4>Total Gagné : <span id="totalGagne" class="text-success">0</span> €</h4>
    </div>
</div>

<!-- ✅ Scripts -->
<script>
document.addEventListener("DOMContentLoaded", async function () {
    await checkUserAuth();
    await loadUserStats();
});

// ✅ Vérifier si l'utilisateur est connecté
async function checkUserAuth() {
    try {
        const response = await axios.get("http://localhost:8082/api/auth/me", { withCredentials: true });
        if (!(response.status === 200 && response.data.email)) {
            alert("Vous devez être connecté pour accéder à cette page.");
            window.location.href = "login.html";
        }
    } catch (error) {
        alert("Session expirée. Veuillez vous reconnecter.");
        window.location.href = "login.html";
    }
}

// ✅ Charger les statistiques de l'utilisateur
async function loadUserStats() {
    try {
        const response = await axios.get("http://localhost:8082/api/statistiques", { withCredentials: true });

        let totalDepense = response.data.totalGrilles * 2.20;
        let totalGagne = response.data.totalGains;
        let historique = response.data.historique;

        document.getElementById("totalDepense").textContent = totalDepense.toFixed(2);
        document.getElementById("totalGagne").textContent = totalGagne.toFixed(2);

        let historiqueList = document.getElementById("historiqueList");
        historiqueList.innerHTML = "";

        let labels = [];
        let depensesData = [];
        let gainsData = [];

        historique.forEach(entry => {
            labels.push(entry.date);
            depensesData.push(entry.grilles * 2.20);
            gainsData.push(entry.gain);

            let listItem = document.createElement("li");
            listItem.className = "list-group-item d-flex justify-content-between";
            listItem.innerHTML = `<strong>${entry.date}</strong> - 🎟 ${entry.grilles} grilles (💰 ${entry.gain} € gagnés)`;
            historiqueList.appendChild(listItem);
        });

        generateChart(labels, depensesData, gainsData);

    } catch (error) {
        console.error("Erreur lors du chargement des statistiques", error);
    }
}

// ✅ Générer le graphique
function generateChart(labels, depensesData, gainsData) {
    let ctx = document.getElementById("statsChart").getContext("2d");

    new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [
                {
                    label: "💸 Dépenses (€)",
                    data: depensesData,
                    borderColor: "red",
                    backgroundColor: "rgba(255, 0, 0, 0.2)",
                    fill: true
                },
                {
                    label: "🏆 Gains (€)",
                    data: gainsData,
                    borderColor: "green",
                    backgroundColor: "rgba(0, 255, 0, 0.2)",
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// ✅ Déconnexion
async function logout() {
    await axios.post("http://localhost:8082/api/auth/logout", {}, { withCredentials: true });
    window.location.href = "index.html";
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
